version: '3'

silent: true

tasks:
  install:
    desc: install dependencies
    cmds: [ task: install-ui ]

  install-ui:
    desc: install ui
    cmds: [ build/run.sh 'install-ui' ui/ npm ci ]

  world:
    desc: run all validation steps
    cmds:
      - task: assert-validate-preconditions
      - task: format
      - task: lint
      - task: test

  assert-validate-preconditions:
    desc: require validation preconditions
    cmds: [ build/run.sh 'validate-preconditions' build/ ./validate-preconditions.sh ]

  format:
    desc: format source-code
    cmds: [ task: format-ui ]

  format-ui:
    desc: format ui
    cmds: [ build/run.sh 'format-ui' ui/ npm run format ]

  lint:
    desc: lint project
    cmds: [ task: lint-ui ]

  lint-ui:
    desc: lint ui
    cmds: [ build/run.sh 'lint-ui' ui/ npm run lint ]

  test:
    desc: run tests
    cmds: [ task: test-ui ]

  test-ui:
    desc: run ui tests
    dir: ui/
    cmds:
      - task: unit-test-ui
      - task: component-test-ui

  unit-test-ui:
    desc: run ui unit-tests
    cmds: [ build/run.sh 'unit-test-ui' ui/ npm run test ]

  component-test-ui:
    desc: run ui component-tests
    deps: [ start-ui ]
    dir: ui/
    cmds:
      - ../build/run.sh 'component-test-ui' ./ npm run component-test
      - task: stop-ui

  start-ui:
    desc: locally start ui
    deps: [ stop-ui ]
    dir: ui/
    cmds:
      - screen -dmS ui npm run start
      - ./wait-healthy.sh

  stop-ui:
    desc: locally stop ui
    cmds: [ '(! lsof -ti tcp:4200 &> /dev/null) || kill -9 $(lsof -ti tcp:4200) &> /dev/null || true' ]

  default:
    cmds: [ task: world ]